<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control ESP32 - MQTT</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><ellipse cx='50' cy='55' rx='25' ry='20' fill='%23666'/><ellipse cx='35' cy='45' rx='18' ry='16' fill='%23777'/><ellipse cx='28' cy='35' rx='8' ry='10' fill='%23555'/><ellipse cx='42' cy='35' rx='8' ry='10' fill='%23555'/><circle cx='30' cy='43' r='3' fill='%23fff'/><circle cx='40' cy='43' r='3' fill='%23fff'/><circle cx='31' cy='43' r='1.5' fill='%23000'/><circle cx='41' cy='43' r='1.5' fill='%23000'/><ellipse cx='35' cy='50' rx='3' ry='2' fill='%23ffc0cb'/><path d='M 75 55 Q 85 50 90 55 Q 95 60 90 65' stroke='%23666' stroke-width='3' fill='none'/></svg>" type="image/svg+xml">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #0a0e27;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
        }

        body::before {
            content: '';
            position: absolute;
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, rgba(100, 50, 200, 0.3) 0%, transparent 70%);
            border-radius: 50%;
            top: -200px;
            right: -200px;
            animation: pulse 4s ease-in-out infinite;
        }

        body::after {
            content: '';
            position: absolute;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(50, 100, 200, 0.3) 0%, transparent 70%);
            border-radius: 50%;
            bottom: -150px;
            left: -150px;
            animation: pulse 4s ease-in-out infinite 2s;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.3; }
            50% { transform: scale(1.1); opacity: 0.5; }
        }

        .rat-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            animation: ratWiggle 2s ease-in-out infinite;
        }

        @keyframes ratWiggle {
            0%, 100% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg); }
        }

        .rat {
            width: 80px;
            height: 80px;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
        }

        .container {
            background: rgba(20, 25, 45, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            max-width: 900px;
            width: 100%;
            padding: 0;
            border: 1px solid rgba(100, 100, 200, 0.2);
            position: relative;
            z-index: 1;
            overflow: hidden;
        }

        .header {
            padding: 30px 40px 20px 40px;
            text-align: center;
        }

        h1 {
            color: #fff;
            font-size: 2em;
            text-shadow: 0 0 20px rgba(100, 150, 255, 0.5);
            margin-bottom: 10px;
        }

        .status {
            padding: 10px;
            border-radius: 8px;
            font-weight: 600;
            text-align: center;
            border: 2px solid;
            display: inline-block;
            min-width: 300px;
        }

        .status.disconnected {
            background: rgba(220, 38, 38, 0.2);
            color: #fca5a5;
            border-color: rgba(220, 38, 38, 0.4);
        }

        .status.connected {
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
            border-color: rgba(34, 197, 94, 0.4);
        }

        .status.connecting {
            background: rgba(251, 191, 36, 0.2);
            color: #fde047;
            border-color: rgba(251, 191, 36, 0.4);
        }

        .tabs {
            display: flex;
            background: rgba(15, 20, 35, 0.8);
            border-bottom: 2px solid rgba(100, 100, 200, 0.2);
        }

        .tab {
            flex: 1;
            padding: 18px;
            text-align: center;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.6);
            font-weight: 600;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            background: transparent;
        }

        .tab:hover {
            background: rgba(100, 100, 200, 0.1);
            color: rgba(255, 255, 255, 0.9);
        }

        .tab.active {
            color: #7b9cff;
            border-bottom-color: #7b9cff;
            background: rgba(100, 100, 200, 0.15);
        }

        .tab-content {
            display: none;
            padding: 40px;
            min-height: 400px;
        }

        .tab-content.active {
            display: block;
        }

        .section h2 {
            color: #7b9cff;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        input[type="text"] {
            flex: 1;
            padding: 14px;
            border: 2px solid rgba(100, 100, 200, 0.3);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
            background: rgba(20, 25, 45, 0.8);
            color: #fff;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #7b9cff;
            box-shadow: 0 0 10px rgba(123, 156, 255, 0.3);
        }

        input[type="text"]::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        button {
            padding: 14px 35px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.5);
        }

        button:disabled {
            background: #555;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .console {
            background: #0d1117;
            color: #c9d1d9;
            border-radius: 8px;
            padding: 20px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            border: 1px solid rgba(100, 100, 200, 0.2);
        }

        .console::-webkit-scrollbar {
            width: 8px;
        }

        .console::-webkit-scrollbar-track {
            background: rgba(20, 25, 45, 0.5);
            border-radius: 4px;
        }

        .console::-webkit-scrollbar-thumb {
            background: rgba(123, 156, 255, 0.5);
            border-radius: 4px;
        }

        .console::-webkit-scrollbar-thumb:hover {
            background: rgba(123, 156, 255, 0.7);
        }

        .console-line {
            margin-bottom: 8px;
            padding: 6px;
            border-left: 3px solid transparent;
            border-radius: 3px;
        }

        .console-line.sent {
            color: #58a6ff;
            border-left-color: #58a6ff;
            background: rgba(88, 166, 255, 0.1);
        }

        .console-line.received {
            color: #79c0ff;
            border-left-color: #79c0ff;
            background: rgba(121, 192, 255, 0.1);
        }

        .console-line.system {
            color: #a5d6ff;
            border-left-color: #a5d6ff;
        }

        .console-line.error {
            color: #ff7b72;
            border-left-color: #ff7b72;
            background: rgba(255, 123, 114, 0.1);
        }

        .timestamp {
            color: #8b949e;
            font-size: 12px;
            margin-right: 10px;
        }

        .clear-btn {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            padding: 10px 25px;
            font-size: 14px;
            margin-top: 10px;
        }

        .clear-btn:hover {
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.5);
        }

        .info-box {
            background: rgba(123, 156, 255, 0.1);
            border: 1px solid rgba(123, 156, 255, 0.3);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            color: #c9d1d9;
        }

        .info-box h3 {
            color: #7b9cff;
            margin-bottom: 10px;
        }

        .info-box p {
            line-height: 1.6;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="rat-container">
        <svg class="rat" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <ellipse cx="50" cy="55" rx="25" ry="20" fill="#666"/>
            <ellipse cx="35" cy="45" rx="18" ry="16" fill="#777"/>
            <ellipse cx="28" cy="35" rx="8" ry="10" fill="#555"/>
            <ellipse cx="42" cy="35" rx="8" ry="10" fill="#555"/>
            <circle cx="30" cy="43" r="3" fill="#fff"/>
            <circle cx="40" cy="43" r="3" fill="#fff"/>
            <circle cx="31" cy="43" r="1.5" fill="#000"/>
            <circle cx="41" cy="43" r="1.5" fill="#000"/>
            <ellipse cx="35" cy="50" rx="3" ry="2" fill="#ffc0cb"/>
            <path d="M 75 55 Q 85 50, 90 55 Q 95 60, 90 65" stroke="#666" stroke-width="3" fill="none"/>
            <rect x="40" y="70" width="4" height="12" rx="2" fill="#666"/>
            <rect x="48" y="70" width="4" height="12" rx="2" fill="#666"/>
            <rect x="56" y="70" width="4" height="12" rx="2" fill="#666"/>
            <rect x="64" y="70" width="4" height="12" rx="2" fill="#666"/>
        </svg>
    </div>

    <div class="container">
        <div class="header">
            <h1>Control ESP32 - MQTT</h1>
            <div id="status" class="status disconnected">Desconectado del broker</div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('connection')">Conexión</div>
            <div class="tab" onclick="switchTab('console')">Consola Serial</div>
            <div class="tab" onclick="switchTab('info')">Información</div>
        </div>

        <!-- Tab Conexión -->
        <div id="connection-tab" class="tab-content active">
            <h2>Conectividad</h2>
            <div class="input-group">
                <input type="text" id="robotName" placeholder="Nombre del Robot (Topic)" value="robot01">
                <button id="connectBtn" onclick="connectRobot()">Conectar</button>
            </div>
            <div class="info-box">
                <h3>Instrucciones:</h3>
                <p>1. Ingresa el nombre del robot (este será el topic MQTT)</p>
                <p>2. Asegúrate de que tu ESP32 esté encendido y conectado</p>
                <p>3. Haz clic en "Conectar" para establecer la conexión</p>
                <p>4. Espera la confirmación del robot</p>
            </div>
        </div>

        <!-- Tab Consola -->
        <div id="console-tab" class="tab-content">
            <h2>Puerto Serial Virtual</h2>
            <div id="console" class="console"></div>
            <div class="input-group" style="margin-top: 15px;">
                <input type="text" id="messageInput" placeholder="Escribe un mensaje..." disabled>
                <button id="sendBtn" onclick="sendMessage()" disabled>Enviar</button>
            </div>
            <button class="clear-btn" onclick="clearConsole()">Limpiar Consola</button>
        </div>

        <!-- Tab Información -->
        <div id="info-tab" class="tab-content">
            <h2>Información del Sistema</h2>
            <div class="info-box">
                <h3>Broker MQTT:</h3>
                <p>Host: 90246ea5b74141e783178f6a189a8171.s1.eu.hivemq.cloud</p>
                <p>Puerto: 8884 (WebSocket Secure)</p>
            </div>
            <div class="info-box">
                <h3>Topics:</h3>
                <p><strong>[nombre_robot]/cmd</strong> - Para enviar comandos al ESP32</p>
                <p><strong>[nombre_robot]/data</strong> - Para recibir datos del ESP32</p>
            </div>
            <div class="info-box">
                <h3>Comandos especiales:</h3>
                <p><strong>CONNECT</strong> - Inicia la conexión con el robot</p>
                <p><strong>CONNECTED</strong> - Respuesta del robot confirmando conexión</p>
            </div>
        </div>
    </div>

    <script>
        let client = null;
        let currentTopic = '';
        let isConnected = false;

        const brokerUrl = 'wss://90246ea5b74141e783178f6a189a8171.s1.eu.hivemq.cloud:8884/mqtt';
        const brokerUsername = 'admin';
        const brokerPassword = 'SuperMan2233';

        function switchTab(tabName) {
            // Remover active de todas las tabs
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Activar la tab seleccionada
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
        }

        function addToConsole(message, type = 'system') {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            const line = document.createElement('div');
            line.className = `console-line ${type}`;
            line.innerHTML = `<span class="timestamp">[${timestamp}]</span>${message}`;
            console.appendChild(line);
            console.scrollTop = console.scrollHeight;
        }

        function updateStatus(status, cssClass) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = status;
            statusDiv.className = `status ${cssClass}`;
        }

        function connectRobot() {
            const robotName = document.getElementById('robotName').value.trim();
            
            if (!robotName) {
                addToConsole('Error: Debes ingresar un nombre de robot', 'error');
                switchTab('console');
                return;
            }

            if (isConnected) {
                disconnectRobot();
                return;
            }

            currentTopic = robotName;
            updateStatus('Conectando al broker...', 'connecting');
            addToConsole(`Intentando conectar con el robot: ${robotName}`, 'system');

            client = mqtt.connect(brokerUrl, {
                clientId: 'web_client_' + Math.random().toString(16).substr(2, 8),
                username: brokerUsername,
                password: brokerPassword,
                clean: true,
                reconnectPeriod: 1000,
            });

            client.on('connect', () => {
                addToConsole('Conectado al broker HiveMQ Cloud', 'system');
                
                client.subscribe(`${currentTopic}/data`, (err) => {
                    if (!err) {
                        addToConsole(`Suscrito al topic: ${currentTopic}/data`, 'system');
                        
                        client.publish(`${currentTopic}/cmd`, 'CONNECT', (err) => {
                            if (!err) {
                                addToConsole(`Enviado: CONNECT`, 'sent');
                                addToConsole('Esperando confirmación del robot...', 'system');
                            }
                        });
                    }
                });
            });

            client.on('message', (topic, message) => {
                const msg = message.toString();
                addToConsole(`Recibido: ${msg}`, 'received');

                if (msg === 'CONNECTED') {
                    isConnected = true;
                    updateStatus(`Conectado al robot: ${currentTopic}`, 'connected');
                    document.getElementById('connectBtn').textContent = 'Desconectar';
                    document.getElementById('messageInput').disabled = false;
                    document.getElementById('sendBtn').disabled = false;
                    document.getElementById('robotName').disabled = true;
                    addToConsole('Conexión exitosa con el robot', 'system');
                }
            });

            client.on('error', (err) => {
                addToConsole(`Error: ${err.message}`, 'error');
                updateStatus('Error de conexión', 'disconnected');
            });

            client.on('close', () => {
                if (isConnected) {
                    addToConsole('Conexión cerrada', 'system');
                    resetConnection();
                }
            });
        }

        function disconnectRobot() {
            if (client) {
                client.end();
                addToConsole('Desconectado del broker', 'system');
            }
            resetConnection();
        }

        function resetConnection() {
            isConnected = false;
            updateStatus('Desconectado del broker', 'disconnected');
            document.getElementById('connectBtn').textContent = 'Conectar';
            document.getElementById('messageInput').disabled = true;
            document.getElementById('sendBtn').disabled = true;
            document.getElementById('robotName').disabled = false;
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message) return;

            if (client && isConnected) {
                client.publish(`${currentTopic}/cmd`, message);
                addToConsole(`Enviado: ${message}`, 'sent');
                input.value = '';
            }
        }

        function clearConsole() {
            document.getElementById('console').innerHTML = '';
            addToConsole('Consola limpiada', 'system');
        }

        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        addToConsole('Sistema iniciado - Listo para conectar', 'system');
    </script>
</body>
</html>
