<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RataLab</title>
    <link rel="icon" type="image/png" href="20251213_180758.png">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
</head>
<body>
    <!-- Barra superior con logo y t√≠tulo -->
    <header class="top-header">
        <!-- Bot√≥n hamburguesa integrado en el header -->
        <button class="hamburger-btn" id="hamburgerBtn">
            <span></span>
            <span></span>
            <span></span>
        </button>
        
        <div class="header-content">
            <img src="20251213_180758.png" alt="RataLab Logo" class="header-logo-large">
            <div class="header-title">
                <h1>RataLab - UTN - FRSF</h1>
                <p class="subtitle">Web App</p>
            </div>
        </div>
    </header>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <nav class="sidebar-nav">
                <div class="tab active" data-tab="info">
                    <span class="tab-text">üìã Foro</span>
                </div>
                <div class="tab" data-tab="connection">
                    <span class="tab-text">üîå Conexi√≥n</span>
                </div>
                <div class="tab" data-tab="control">
                    <span class="tab-text">üéÆ Control Manual</span>
                </div>
                <div class="tab" data-tab="maze">
                    <span class="tab-text">üó∫Ô∏è Trayectoria</span>
                </div>
                <div class="tab" data-tab="console">
                    <span class="tab-text">üíª Consola Serial</span>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div id="status" class="status disconnected">Desconectado</div>
                <div class="logo-container">
                    <img src="20251213_180758.png" alt="RataLab" class="footer-logo">
                    <img src="logo.svg" alt="UTN" class="footer-logo">
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- FORO TAB (PREDETERMINADA) -->
            <div id="info-tab" class="tab-content active">
                <h2>Foro del Proyecto</h2>
                
                <div class="info-box">
                    <h3>¬øQu√© es RataLab?</h3>
                    <p>RataLab es una plataforma web innovadora desarrollada por estudiantes de la Universidad Tecnol√≥gica Nacional - Facultad Regional San Fransisco (UTN-FRSF) para el control, monitoreo y an√°lisis de robots m√≥viles aut√≥nomos especializados en la resoluci√≥n de laberintos.</p>
                    <p>Este proyecto integra m√∫ltiples disciplinas de la ingenier√≠a electr√≥nica, combinando programaci√≥n de sistemas embebidos, comunicaciones IoT, algoritmos de optimizaci√≥n y desarrollo web para crear una soluci√≥n completa de rob√≥tica educativa.</p>
                    <p>El sistema permite la interacci√≥n en tiempo real con robots basados en ESP32, visualizaci√≥n de trayectorias, control manual mediante interfaz web o teclado, y la aplicaci√≥n de algoritmos avanzados de pathfinding para encontrar rutas √≥ptimas en laberintos complejos.</p>
                </div>

                <div class="info-box">
                    <h3>Tecnolog√≠as Utilizadas</h3>
                    <p><strong>Hardware:</strong> Placa de desarrollo ESP32 con conectividad WiFi integrada, sensores ultras√≥nicos HC-SR04 para detecci√≥n de obst√°culos, sensores infrarrojos para seguimiento de l√≠nea, encoders para odometr√≠a precisa y motores DC con driver L298N.</p>
                    <p><strong>Comunicaci√≥n:</strong> Protocolo MQTT (Message Queuing Telemetry Transport), un protocolo ultraligero de mensajer√≠a publish/subscribe ideal para aplicaciones IoT. Utilizamos HiveMQ Cloud como broker para garantizar comunicaci√≥n confiable y de baja latencia.</p>
                    <p><strong>Software:</strong> Frontend desarrollado con HTML5, CSS3 y JavaScript vanilla para m√°xima compatibilidad. Backend embebido en ESP32 programado con Arduino IDE. Algoritmos de resoluci√≥n de laberintos implementados: A* (heur√≠stico), Dijkstra (√≥ptimo) y BFS (amplitud).</p>
                    <p><strong>Matem√°tica de Optimizaci√≥n:</strong> Implementaci√≥n de grafos para representaci√≥n del laberinto, funciones heur√≠sticas para A*, y algoritmos de b√∫squeda en grafos para encontrar el camino m√°s corto entre dos puntos.</p>
                </div>

                <div class="info-box">
                    <h3>Caracter√≠sticas del Robot</h3>
                    <p>‚Ä¢ <strong>Navegaci√≥n Aut√≥noma:</strong> Capacidad de explorar laberintos sin intervenci√≥n humana utilizando sensores ultras√≥nicos e infrarrojos.</p>
                    <p>‚Ä¢ <strong>Control Remoto:</strong> Operaci√≥n manual desde la interfaz web con controles de teclado (W, A, S, D, X) o botones t√°ctiles.</p>
                    <p>‚Ä¢ <strong>Odometr√≠a Precisa:</strong> Sistema de encoders que registra cada movimiento del robot con precisi√≥n de cent√≠metros.</p>
                    <p>‚Ä¢ <strong>Visualizaci√≥n en Tiempo Real:</strong> Gr√°fico din√°mico de la trayectoria recorrida con escala ajustable.</p>
                    <p>‚Ä¢ <strong>Algoritmos Inteligentes:</strong> Tres algoritmos de resoluci√≥n disponibles para comparar eficiencia y rendimiento.</p>
                </div>

                <div class="info-box download-section">
                    <h3>Descargas</h3>
                    
                    <!-- Manual de Usuario -->
                    <div class="download-category">
                        <div class="category-header">
                            <div class="download-icon">üìÑ</div>
                            <div class="category-info">
                                <h4>Manual de Usuario</h4>
                                <p>Gu√≠a completa de instalaci√≥n, configuraci√≥n y uso del sistema RataLab</p>
                            </div>
                        </div>
                        <a href="https://raw.githubusercontent.com/Eltomyalfonzo/RataLab/main/Manual_RataLab.pdf" download class="download-btn">
                            Descargar Manual (PDF)
                        </a>
                    </div>

                    <!-- Firmwares -->
                    <div class="download-category">
                        <div class="category-header" onclick="toggleFirmwareList()">
                            <div class="download-icon">üíæ</div>
                            <div class="category-info">
                                <h4>Firmwares ESP32 <span class="expand-arrow" id="firmwareArrow">‚ñº</span></h4>
                                <p>C√≥digo fuente para cargar en la placa ESP32 del robot</p>
                            </div>
                        </div>
                        
                        <div class="firmware-list" id="firmwareList" style="display: none;">
                            <div class="firmware-item">
                                <div class="firmware-info">
                                    <strong>Firmware v1.0 - B√°sico</strong>
                                    <span class="firmware-tag">Estable</span>
                                    <p>Control manual y modo autom√°tico con sensores ultras√≥nicos</p>
                                </div>
                                <a href="https://raw.githubusercontent.com/Eltomyalfonzo/RataLab/main/firmware_esp32.ino" download class="download-btn-small">
                                    Descargar
                                </a>
                            </div>
                            
                            <div class="firmware-item">
                                <div class="firmware-info">
                                    <strong>Firmware v1.1 - Encoders</strong>
                                    <span class="firmware-tag firmware-tag-beta">Beta</span>
                                    <p>Incluye soporte para encoders y odometr√≠a avanzada</p>
                                </div>
                                <a href="https://raw.githubusercontent.com/Eltomyalfonzo/RataLab/main/firmware_esp32_v1.1.ino" download class="download-btn-small">
                                    Descargar
                                </a>
                            </div>
                            
                            <div class="firmware-item">
                                <div class="firmware-info">
                                    <strong>Firmware v2.0 - Laberintos</strong>
                                    <span class="firmware-tag firmware-tag-new">Nuevo</span>
                                    <p>Algoritmos de resoluci√≥n de laberintos integrados (A*, Dijkstra, BFS)</p>
                                </div>
                                <a href="https://raw.githubusercontent.com/Eltomyalfonzo/RataLab/main/firmware_esp32_v2.0.ino" download class="download-btn-small">
                                    Descargar
                                </a>
                            </div>
                            
                            <div class="firmware-item">
                                <div class="firmware-info">
                                    <strong>Firmware v2.1 - Completo</strong>
                                    <span class="firmware-tag firmware-tag-recommended">Recomendado</span>
                                    <p>Versi√≥n completa con todas las caracter√≠sticas optimizadas</p>
                                </div>
                                <a href="https://raw.githubusercontent.com/Eltomyalfonzo/RataLab/main/firmware_esp32_v2.1.ino" download class="download-btn-small">
                                    Descargar
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recursos Adicionales -->
                    <div class="download-category">
                        <div class="category-header">
                            <div class="download-icon">üîß</div>
                            <div class="category-info">
                                <h4>Recursos Adicionales</h4>
                                <p>Bibliotecas, esquem√°ticos y archivos de soporte</p>
                            </div>
                        </div>
                        <div class="github-link">
                            <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
                            </svg>
                            <a href="https://github.com/Eltomyalfonzo/RataLab" target="_blank" rel="noopener noreferrer">github.com/Eltomyalfonzo/RataLab</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CONNECTION TAB -->
            <div id="connection-tab" class="tab-content">
                <h2>Conexi√≥n MQTT</h2>
                
                <div class="info-box">
                    <h3>Estado de la Conexi√≥n</h3>
                    <p>Introduce el nombre de tu robot y presiona "Conectar" para establecer la comunicaci√≥n.</p>
                </div>
                
                <div class="input-group">
                    <input type="text" id="robotName" placeholder="Nombre del robot (ej: robot01)">
                    <button id="connectBtn">Conectar</button>
                </div>
                
                <div class="info-box">
                    <h3>Configuraci√≥n del Broker</h3>
                    <p><strong>Broker:</strong> HiveMQ Cloud</p>
                    <p><strong>URL:</strong> f9d90e4c488c4716ac1e5862b9c8a708.s1.eu.hivemq.cloud</p>
                    <p><strong>Puerto:</strong> 8884 (WSS)</p>
                    <p><strong>Topic de comandos:</strong> [nombre_robot]/cmd</p>
                    <p><strong>Topic de datos:</strong> [nombre_robot]/data</p>
                </div>
                
                <div class="info-box">
                    <h3>Instrucciones</h3>
                    <p>1. Aseg√∫rate de que tu robot ESP32 est√© encendido y conectado a WiFi</p>
                    <p>2. El robot debe estar programado con el mismo nombre que introduces arriba</p>
                    <p>3. Una vez conectado, podr√°s enviar comandos y recibir datos del robot</p>
                    <p>4. El indicador de estado mostrar√° "Conectado" cuando la comunicaci√≥n est√© establecida</p>
                </div>
            </div>

            <!-- CONTROL TAB -->
            <div id="control-tab" class="tab-content">
                <h2>Control Manual del Robot</h2>
                
                <div class="control-status-box">
                    <div id="controlStatus" class="control-disabled">‚ö†Ô∏è Conecta el robot primero</div>
                </div>

                <!-- ===== PANEL: MODO AUT√ìNOMO ===== -->
                <div class="auto-panel">
                    <h3>ü§ñ Modo Aut√≥nomo</h3>
                    <p>Env√≠a la se√±al <code>MV</code> al robot para que inicie la navegaci√≥n aut√≥noma con sus sensores.</p>
                    <div class="auto-btn-row">
                        <button class="auto-btn auto-btn-mv" id="btnModoAutonomo" disabled>
                            <span class="auto-btn-icon">üöÄ</span>
                            <span class="auto-btn-label">Iniciar Modo Aut√≥nomo</span>
                            <span class="auto-btn-sub">Env√≠a MV</span>
                        </button>
                        <button class="auto-btn auto-btn-stop-mv" onclick="MQTTClient.sendMessage('S')" disabled id="btnStopAutonomo">
                            <span class="auto-btn-icon">‚èπÔ∏è</span>
                            <span class="auto-btn-label">Detener Aut√≥nomo</span>
                            <span class="auto-btn-sub">Env√≠a S</span>
                        </button>
                    </div>
                </div>

                <!-- ===== PANEL: EJECUTAR RUTA DEL ALGORITMO ===== -->
                <div class="auto-panel auto-panel-route">
                    <h3>üó∫Ô∏è Ejecutar Ruta del Algoritmo</h3>
                    <p>Mueve el robot f√≠sicamente siguiendo el camino √≥ptimo calculado por el algoritmo de resoluci√≥n. <strong>Resuelve el laberinto primero</strong> desde la pesta√±a Trayectoria.</p>

                    <div id="pathStatus" class="path-status path-status-idle">
                        Listo para ejecutar
                    </div>

                    <div class="auto-btn-row">
                        <button class="auto-btn auto-btn-route" id="btnEjecutarRuta" disabled>
                            <span class="auto-btn-icon">‚ñ∂Ô∏è</span>
                            <span class="auto-btn-label">Ejecutar Ruta</span>
                            <span class="auto-btn-sub">Sigue el camino √≥ptimo</span>
                        </button>
                        <button class="auto-btn auto-btn-abort" id="btnAbortarRuta" disabled style="display:none;">
                            <span class="auto-btn-icon">‚õî</span>
                            <span class="auto-btn-label">Abortar Ruta</span>
                            <span class="auto-btn-sub">Detiene inmediatamente</span>
                        </button>
                    </div>

                    <div class="route-info">
                        <span id="routeStepsInfo">Sin ruta cargada ‚Äî ve a Trayectoria y resuelve el laberinto</span>
                    </div>
                </div>
                
                <div class="control-panel">
                    <div class="control-row">
                        <div class="control-spacer"></div>
                        <button class="control-btn" id="btnForward" disabled>
                            <div class="arrow">‚ñ≤</div>
                            <div class="label">Adelante<br>(W)</div>
                        </button>
                        <div class="control-spacer"></div>
                    </div>
                    
                    <div class="control-row">
                        <button class="control-btn" id="btnLeft" disabled>
                            <div class="arrow">‚óÑ</div>
                            <div class="label">Izquierda<br>(A)</div>
                        </button>
                        <button class="control-btn stop-btn" id="btnStop" disabled>
                            <div class="arrow">‚ñ†</div>
                            <div class="label">Detener<br>(S)</div>
                        </button>
                        <button class="control-btn" id="btnRight" disabled>
                            <div class="arrow">‚ñ∫</div>
                            <div class="label">Derecha<br>(D)</div>
                        </button>
                    </div>
                    
                    <div class="control-row">
                        <div class="control-spacer"></div>
                        <button class="control-btn" id="btnBackward" disabled>
                            <div class="arrow">‚ñº</div>
                            <div class="label">Atr√°s<br>(X)</div>
                        </button>
                        <div class="control-spacer"></div>
                    </div>
                </div>
                
                <div class="control-settings">
                    <label>
                        Velocidad del Robot:
                        <input type="range" id="speedSlider" min="50" max="255" value="150" disabled>
                        <span id="speedValue">150</span>
                    </label>
                </div>
                
                <div class="info-box">
                    <h3>Controles de Teclado</h3>
                    <p><strong>W</strong> - Adelante</p>
                    <p><strong>A</strong> - Izquierda</p>
                    <p><strong>S</strong> - Detener</p>
                    <p><strong>D</strong> - Derecha</p>
                    <p><strong>X</strong> - Atr√°s</p>
                    <p class="note">Los controles de teclado solo funcionan cuando el robot est√° conectado.</p>
                </div>
            </div>

            <!-- MAZE TAB -->
            <div id="maze-tab" class="tab-content">
                <h2>Visualizaci√≥n de Trayectoria</h2>
                
                <div class="maze-controls">
                    <button onclick="Maze.clear()">üóëÔ∏è Limpiar Canvas</button>
                    <input type="file" id="mazeFile" accept=".txt,.csv" style="display: none;">
                    <button onclick="document.getElementById('mazeFile').click()">üìÇ Cargar Archivo</button>
                    <button onclick="exportMazeData()">üíæ Exportar Datos</button>
                </div>
                
                <div class="solver-controls">
                    <h3>ü§ñ Resoluci√≥n Autom√°tica</h3>
                    <div class="solver-group">
                        <label>Algoritmo:</label>
                        <select id="algorithmSelect">
                            <option value="astar">A* (Heur√≠stico)</option>
                            <option value="dijkstra">Dijkstra (√ìptimo)</option>
                            <option value="bfs">BFS (Amplitud)</option>
                        </select>
                        <button onclick="solveMaze()">
                            ‚ñ∂Ô∏è Resolver Laberinto
                        </button>
                        <button id="toggleSolutionBtn" onclick="toggleSolution()" style="display: none;">
                            Ocultar Soluci√≥n
                        </button>
                    </div>
                </div>
                
                <div class="maze-settings">
                    <label>
                        Escala (px/cm): 
                        <input type="number" id="scale" value="4" min="1" max="20" step="1"
                               onchange="Maze.setScale(parseFloat(this.value))">
                        <span style="font-size:0.8em;color:#64748b;">(celda = valor √ó 25 px)</span>
                    </label>
                </div>
                
                <div class="canvas-container">
                    <canvas id="mazeCanvas"></canvas>
                </div>
                
                <div class="info-box">
                    <h3>Formato de datos:</h3>
                    <p>Cada l√≠nea representa una coordenada (X,Y) en cent√≠metros. Los puntos se agrupan en celdas de <strong>25√ó25 cm</strong> (reglamento):</p>
                    <pre style="background: #f8f9fa; padding: 10px; border-radius: 4px; color: #1e293b; border: 1px solid #e2e8f0;">0,0
0.5,0
1.2,0.3
2.5,1.8
...</pre>
                    <p><span class="legend-color" style="background: #22c55e;"></span> <strong>Verde:</strong> Celda de inicio</p>
                    <p><span class="legend-color" style="background: #ef4444;"></span> <strong>Rojo:</strong> Celda final</p>
                    <p><span class="legend-color" style="background: #3b82f6;"></span> <strong>Azul:</strong> Celdas recorridas (centro a centro)</p>
                    <p><span class="legend-color" style="background: #f59e0b;"></span> <strong>Amarillo:</strong> Camino √≥ptimo del algoritmo (por centros de celda)</p>
                </div>
            </div>

            <!-- CONSOLE TAB -->
            <div id="console-tab" class="tab-content">
                <h2>Puerto Serial Virtual</h2>
                <div id="console" class="console"></div>
                <div class="input-group" style="margin-top: 15px;">
                    <input type="text" id="messageInput" placeholder="Escribe un mensaje..." disabled>
                    <button id="sendBtn" disabled>Enviar</button>
                </div>
                <button class="clear-btn">Limpiar Consola</button>
            </div>
        </main>
    </div>

    <script src="config.js"></script>
    <script src="console.js"></script>
    <script src="maze.js"></script>
    <script src="solver.js"></script>
    <script src="control.js"></script>
    <script src="ui.js"></script>
    <script src="mqtt.js"></script>
    <script>
        // Men√∫ hamburguesa - debe ejecutarse ANTES de DOMContentLoaded
        window.addEventListener('load', () => {
            const hamburgerBtn = document.getElementById('hamburgerBtn');
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('.main-content');
            
            if (hamburgerBtn && sidebar && mainContent) {
                hamburgerBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    sidebar.classList.toggle('sidebar-hidden');
                    mainContent.classList.toggle('sidebar-hidden');
                    hamburgerBtn.classList.toggle('active');
                    console.log('Hamburger clicked, sidebar hidden:', sidebar.classList.contains('sidebar-hidden'));
                });
                
                // Cerrar sidebar al hacer click en una tab (en m√≥viles)
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        if (window.innerWidth <= 768) {
                            sidebar.classList.add('sidebar-hidden');
                            mainContent.classList.add('sidebar-hidden');
                            hamburgerBtn.classList.remove('active');
                        }
                    });
                });
            }
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            // Archivo de laberinto
            document.getElementById('mazeFile').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    Maze.loadFromFile(file);
                }
            });
        });

        function toggleFirmwareList() {
            const list = document.getElementById('firmwareList');
            const arrow = document.getElementById('firmwareArrow');
            
            if (list.style.display === 'none') {
                list.style.display = 'block';
                arrow.textContent = '‚ñ≤';
            } else {
                list.style.display = 'none';
                arrow.textContent = '‚ñº';
            }
        }

        function exportMazeData() {
            const data = Maze.exportData();
            if (!data) {
                Console.logError('No hay datos para exportar');
                return;
            }
            
            const blob = new Blob([data], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `trayectoria_${new Date().getTime()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            Console.logSystem('Datos exportados exitosamente');
        }

        function solveMaze() {
            const algorithm = document.getElementById('algorithmSelect').value;
            const solution = MazeSolver.solve(algorithm);
            
            if (solution) {
                Maze.setSolution(solution);
                document.getElementById('toggleSolutionBtn').style.display = 'inline-block';
                Console.logSystem(`‚úì Laberinto resuelto con ${algorithm.toUpperCase()} ‚Äî ${solution.length - 1} pasos`);
                // Notificar al control para que muestre la info de ruta
                RobotControl.actualizarInfoRuta();
            }
        }

        function toggleSolution() {
            Maze.toggleSolution();
            const btn = document.getElementById('toggleSolutionBtn');
            btn.textContent = Maze.showSolution ? 'Ocultar Soluci√≥n' : 'Mostrar Soluci√≥n';
        }
    </script>
</body>
</html>
